<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sara Wellness | Blog</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="./style.css">

  <style>
    body {
      background: linear-gradient(135deg, rgba(46, 139, 87, 0.06), rgba(255, 255, 255, 1));
      min-height: 100vh;
    }

    h1 {
      text-align: center;
      margin: 0;
      font-size: clamp(28px, 4vw, 48px);
      font-weight: 900;
      letter-spacing: 0.2px;
      color: #ff2a4a;
      text-shadow: 0 10px 25px rgba(0, 0, 0, .18);
    }

    .underline {
      width: 96px;
      height: 4px;
      border-radius: 999px;
      background: #ffd400;
      margin: 14px auto 0;
      box-shadow: 0 10px 20px rgba(0, 0, 0, .18);
    }

    .page-wrap {
      padding: 28px 0 70px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 18px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      margin-bottom: 18px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 14px;
      flex-wrap: wrap;
    }

    .topbar h2 {
      margin: 0;
      line-height: 1.1;
    }

    .topbar p {
      margin: 6px 0 0;
      color: #555;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-top: 16px;
    }

    @media (max-width: 1050px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 700px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .b-card {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 310px;
    }

    .b-img {
      height: 170px;
      background: rgba(46, 139, 87, 0.06);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .b-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .b-body {
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
    }

    .b-meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      font-size: 12px;
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(46, 139, 87, 0.10);
      color: #1e6a42;
    }

    .pill.draft {
      background: rgba(255, 193, 7, 0.14);
      color: #8a6a00;
    }

    .b-title {
      font-weight: 900;
      color: #222;
      line-height: 1.25;
    }

    .b-excerpt {
      color: #444;
      font-size: 14px;
      line-height: 1.55;
    }

    .b-foot {
      margin-top: auto;
      font-size: 12px;
      color: #777;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .btn-small {
      padding: 10px 12px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 800;
    }

    .btn-ghost {
      background: rgba(46, 139, 87, 0.10);
      color: #1e6a42;
    }

    .btn-edit {
      background: rgba(13, 110, 253, 0.10);
      color: #0b4db3;
    }

    .alert {
      display: none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      border: 1px solid transparent;
    }

    .alert.success {
      display: block;
      background: rgba(46, 139, 87, 0.10);
      border-color: rgba(46, 139, 87, 0.30);
      color: #1e6a42;
    }

    .alert.error {
      display: block;
      background: rgba(220, 53, 69, 0.08);
      border-color: rgba(220, 53, 69, 0.25);
      color: #b02a37;
    }

    .alert i {
      margin-right: 8px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }

    @media (max-width: 850px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field label {
      font-size: 14px;
      color: #333;
      font-weight: 800;
    }

    .field input,
    .field select,
    .field textarea {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      outline: none;
      background: #fff;
      transition: .2s ease;
    }

    .field textarea {
      min-height: 140px;
      resize: vertical;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      border-color: rgba(46, 139, 87, 0.65);
      box-shadow: 0 0 0 4px rgba(46, 139, 87, 0.12);
    }

    .actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }

    .small {
      color: #666;
      font-size: 13px;
      line-height: 1.5;
      margin-top: 8px;
    }

    /* ======= Modal ======= */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 9999;
      padding: 20px;
      overflow: auto;
    }

    .modal {
      background: #fff;
      max-width: 900px;
      width: 100%;
      margin: 5vh auto;
      border-radius: 16px;
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .modal-head {
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      background: rgba(46, 139, 87, 0.06);
    }

    .modal-title {
      margin: 0;
      font-size: 18px;
      font-weight: 900;
      color: #222;
      line-height: 1.2;
    }

    .close-btn {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      padding: 8px 10px;
      border-radius: 10px;
    }

    .close-btn:hover {
      background: rgba(0, 0, 0, 0.06);
    }

    .modal-body {
      padding: 16px;
    }

    .full-img {
      width: 100%;
      height: 320px;
      background: rgba(46, 139, 87, 0.06);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 14px;
    }

    .full-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .full-meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }

    .full-content {
      color: #333;
      line-height: 1.8;
      white-space: pre-wrap;
    }

    footer a {
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div id="header-placeholder"></div>

  <section class="page-wrap">
    <div class="container">
      <h1>Wellness Blog</h1>
      <div class="underline"></div>
      <h3 style="margin: 20px auto 60px; text-align: center;">Tips, insights, and latest research on physical and mental health.</h3>
      <!-- BLOG LIST (no filters, no profile/refresh buttons) -->
      <div class="card">
        <div class="topbar">
          <div>


          </div>
        </div>

        <div id="blog-alert" class="alert"></div>
        <p id="blog-status" class="small" style="margin-top:10px;">Loading blogs...</p>

        <div class="grid" id="blog-grid"></div>
      </div>

      <!-- ADMIN CREATE BLOG -->
      <div class="card" id="admin-create-card" style="display:none;">
        <div class="topbar">
          <div>
            <h3 style="margin:0;">Create Blog Post (Admin)</h3>
            <p class="small" style="margin:6px 0 0;">
              Required: <b>title, content, category</b>. Excerpt auto-generates if empty.
            </p>
          </div>
          <div class="pill" style="background:rgba(13,110,253,0.10); color:#0b4db3;">
            <i class="fa-solid fa-shield-halved"></i> Admin
          </div>
        </div>

        <div id="create-alert" class="alert"></div>

        <form id="create-blog-form">
          <div class="form-grid">

            <div class="field" style="grid-column:1/-1;">
              <label for="title">Title *</label>
              <input id="title" type="text" required placeholder="Enter blog title...">
            </div>

            <div class="field">
              <label for="category">Category *</label>
              <input id="category" type="text" required placeholder="e.g. Nutrition, Fitness, Mental Health">
            </div>

            <div class="field">
              <label for="author">Author (auto)</label>
              <input id="author" type="text" placeholder="Sara Wellness Team" disabled>
            </div>

            <div class="field" style="grid-column:1/-1;">
              <label for="content">Content *</label>
              <textarea id="content" required placeholder="Write the blog content..."></textarea>
            </div>

            <div class="field" style="grid-column:1/-1;">
              <label for="excerpt">Excerpt (auto-generated if empty) *</label>
              <textarea id="excerpt" placeholder="Short summary... (optional)"></textarea>
              <div class="small">If empty, it will auto-generate from content (required by your model).</div>
            </div>

            <div class="field">
              <label for="imageFile">Upload Image (local) (optional)</label>
              <input id="imageFile" type="file" accept="image/*">
              <div class="small">This uploads locally to your backend (multipart/form-data).</div>
            </div>

            <div class="field">
              <label for="tags">Tags (optional)</label>
              <input id="tags" type="text" placeholder="comma separated e.g. diet, protein, sleep">
              <div class="small">If empty, tags will be auto-generated from category.</div>
            </div>

            <div class="field">
              <label for="published">Published</label>
              <select id="published">
                <option value="false" selected>Draft (false)</option>
                <option value="true">Publish (true)</option>
              </select>
            </div>

          </div>

          <div class="actions">
            <button class="btn" type="submit" id="createBtn">
              <i class="fa-solid fa-plus" style="margin-right:8px;"></i> Create Blog
            </button>

            <span class="small">createdAt/updatedAt are automatic in database.</span>
          </div>
        </form>
      </div>

    </div>
  </section>

  <!-- ======= Full Blog Modal ======= -->
  <div id="viewModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h3 id="viewTitle" class="modal-title">Blog</h3>
        <button class="close-btn" id="closeViewModal" title="Close">✕</button>
      </div>
      <div class="modal-body">
        <div class="full-img" id="viewImageWrap">
          <i class="fa-solid fa-image" style="font-size:34px; color:#2E8B57;"></i>
        </div>

        <div class="full-meta">
          <div class="pill" id="viewCategory">Category</div>
          <div class="pill" id="viewPublished">Draft</div>
        </div>

        <div class="small" id="viewInfo"></div>

        <hr style="border:none; border-top:1px solid rgba(0,0,0,0.08); margin:12px 0;">

        <div class="full-content" id="viewContent"></div>

        <div class="small" id="viewTags" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- ======= Edit Blog Modal (Admin) ======= -->
  <div id="editModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h3 class="modal-title"><i class="fa-solid fa-pen-to-square" style="margin-right:8px;"></i> Edit Blog (Admin)
        </h3>
        <button class="close-btn" id="closeEditModal" title="Close">✕</button>
      </div>

      <div class="modal-body">
        <div id="edit-alert" class="alert"></div>

        <form id="edit-blog-form">
          <input type="hidden" id="editId" />

          <div class="form-grid">
            <div class="field" style="grid-column:1/-1;">
              <label for="editTitle">Title *</label>
              <input id="editTitle" type="text" required>
            </div>

            <div class="field">
              <label for="editCategory">Category *</label>
              <input id="editCategory" type="text" required>
            </div>

            <div class="field">
              <label for="editAuthor">Author (auto)</label>
              <input id="editAuthor" type="text" disabled>
            </div>

            <div class="field" style="grid-column:1/-1;">
              <label for="editContent">Content *</label>
              <textarea id="editContent" required></textarea>
            </div>

            <div class="field" style="grid-column:1/-1;">
              <label for="editExcerpt">Excerpt (auto-generated if empty) *</label>
              <textarea id="editExcerpt" placeholder="Optional, will auto-generate if empty"></textarea>
            </div>

            <div class="field">
              <label>Current Image</label>
              <div class="small" id="editCurrentImage">No image</div>
            </div>

            <div class="field">
              <label for="editImageFile">Replace Image (local upload)</label>
              <input id="editImageFile" type="file" accept="image/*">
            </div>

            <div class="field">
              <label for="editTags">Tags (optional)</label>
              <input id="editTags" type="text" placeholder="comma separated e.g. diet, protein, sleep">
            </div>

            <div class="field">
              <label for="editPublished">Published</label>
              <select id="editPublished">
                <option value="false">Draft (false)</option>
                <option value="true">Publish (true)</option>
              </select>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="submit" id="saveEditBtn">
              <i class="fa-solid fa-floppy-disk" style="margin-right:8px;"></i> Save Changes
            </button>
            <span class="small">Only admins can edit.</span>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="footer-container">

      <div class="footer-col">
        <h4>Sara Wellness</h4>
        <p>
          Holistic approaches to wellness that integrate physical health with mental wellbeing
          for a balanced, fulfilling life.
        </p>
      </div>

      <div class="footer-col">
        <h4>Services</h4>
        <ul>
          <li><a href="weight-loss.html">Weight Loss</a></li>
          <li><a href="hair-loss.html">Hair Loss</a></li>
          <li><a href="skin-care.html">Skin Care</a></li>
          <li><a href="stress-management.html">Stress Management</a></li>
          <li><a href="pain-relief.html">Pain Relief</a></li>
          <li><a href="personal-problems.html">Personal Problems</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h4>Quick Links</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="services.html">Services</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="testimonials.html">Testimonials</a></li>
          <li><a href="blog.html">Blog</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </div>

      <div class="footer-col">
        <h4>Newsletter</h4>
        <p>Subscribe to our newsletter for wellness tips and updates.</p>
        <form onsubmit="event.preventDefault(); alert('Thanks for subscribing!');">
          <input type="email" placeholder="Your Email" required>
          <button type="submit" class="btn">Subscribe</button>
        </form>
      </div>

    </div>

    <div class="copyright">
      <p>&copy; 2023 Sara Wellness. All rights reserved.</p>
    </div>
  </div>
</footer>


  <script>
    const API_BASE = "https://backend-sarawellness.onrender.com";

    const blogGrid = document.getElementById("blog-grid");
    const statusEl = document.getElementById("blog-status");
    const alertEl = document.getElementById("blog-alert");

    const adminCard = document.getElementById("admin-create-card");
    const createForm = document.getElementById("create-blog-form");
    const createAlert = document.getElementById("create-alert");

    const viewBackdrop = document.getElementById("viewModalBackdrop");
    const closeViewModal = document.getElementById("closeViewModal");

    const editBackdrop = document.getElementById("editModalBackdrop");
    const closeEditModal = document.getElementById("closeEditModal");
    const editForm = document.getElementById("edit-blog-form");
    const editAlert = document.getElementById("edit-alert");

    let allBlogs = [];

    function getToken() { return localStorage.getItem("token"); }
    function getUser() { try { return JSON.parse(localStorage.getItem("user") || "null"); } catch { return null; } }
    function isAdmin() { const u = getUser(); return (u?.role || "").toLowerCase() === "admin"; }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showAlert(el, type, message) {
      el.className = `alert ${type}`;
      el.innerHTML = type === "success"
        ? `<i class="fa-solid fa-circle-check"></i>${message}`
        : `<i class="fa-solid fa-triangle-exclamation"></i>${message}`;
      el.style.display = "block";
    }
    function hideAlert(el) { el.style.display = "none"; el.className = "alert"; el.innerHTML = ""; }

    function formatDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
    }

    function normalizeBlogs(payload) {
      if (Array.isArray(payload)) return payload;
      if (Array.isArray(payload?.blogs)) return payload.blogs;
      if (Array.isArray(payload?.data)) return payload.data;
      if (Array.isArray(payload?.results)) return payload.results;
      return [];
    }

    function setAdminVisibility() {
      adminCard.style.display = isAdmin() ? "block" : "none";
      const authorInput = document.getElementById("author");
      const u = getUser();
      if (authorInput) authorInput.value = u?.name ? u.name : "Sara Wellness Team";
    }

    // ✅ make image handling robust (supports /uploads/... or uploads/... or full URL or windows paths)
    function resolveImageUrl(image) {
      if (!image) return "";
      let s = String(image).trim();
      if (!s) return "";
      s = s.replaceAll("\\", "/");
      if (s.startsWith("http://") || s.startsWith("https://")) return s;

      const idx = s.toLowerCase().indexOf("/uploads/");
      if (idx !== -1) s = s.slice(idx);

      if (s.toLowerCase().startsWith("uploads/")) s = "/" + s;
      return s.startsWith("/") ? `${API_BASE}${s}` : `${API_BASE}/${s}`;
    }

    function autoExcerpt(content, maxLen = 160) {
      const txt = (content || "").trim().replace(/\s+/g, " ");
      if (!txt) return "";
      return txt.length > maxLen ? txt.slice(0, maxLen).trim() + "..." : txt;
    }

    function autoTags(category, content) {
      const base = [];
      if (category) base.push(category.toLowerCase());
      const text = (content || "").toLowerCase();
      const keywords = ["diet", "nutrition", "exercise", "fitness", "sleep", "stress", "anxiety", "skin", "hair", "pain", "mindfulness"];
      const found = keywords.filter(k => text.includes(k)).slice(0, 5);
      return Array.from(new Set([...base, ...found])).filter(Boolean);
    }

    function render(blogs) {
      blogGrid.innerHTML = "";

      if (!blogs.length) {
        statusEl.textContent = "No blog posts found.";
        return;
      }

      statusEl.textContent = `${blogs.length} blog post(s) found.`;

      const admin = isAdmin();

      blogs.forEach((b) => {
        const id = b._id || b.id;
        const title = b.title || "Untitled";
        const content = b.content || "";
        const excerpt = b.excerpt || autoExcerpt(content, 180);
        const author = b.author || "Sara Wellness Team";
        const category = b.category || "General";
        const tags = Array.isArray(b.tags) ? b.tags : [];
        const published = Boolean(b.published);
        const date = formatDate(b.createdAt);
        const imgUrl = resolveImageUrl(b.image);

        const card = document.createElement("div");
        card.className = "b-card";
        card.innerHTML = `
          <div class="b-img">
            ${imgUrl
            ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(title)}" onerror="this.parentElement.innerHTML='<i class=\\'fa-solid fa-image\\' style=\\'font-size:34px; color:#2E8B57;\\'></i>'">`
            : `<i class="fa-solid fa-image" style="font-size:34px; color:#2E8B57;"></i>`
          }
          </div>

          <div class="b-body">
            <div class="b-meta">
              <div class="pill">${escapeHtml(category)}</div>
              <div class="pill ${published ? "" : "draft"}">${published ? "Published" : "Draft"}</div>
            </div>

            <div class="b-title">${escapeHtml(title)}</div>
            <div class="b-excerpt">${escapeHtml(excerpt)}</div>

            <div class="b-foot">
              <span><i class="fa-solid fa-user-pen"></i> ${escapeHtml(author)}</span>
              <span>${date ? `<i class="fa-regular fa-calendar"></i> ${escapeHtml(date)}` : ""}</span>
            </div>

            ${tags.length ? `<div class="small"><i class="fa-solid fa-tags"></i> ${escapeHtml(tags.join(", "))}</div>` : ""}

            <div class="btn-row">
              <button class="btn-small btn-ghost" type="button" data-action="view" data-id="${escapeHtml(id)}">
                <i class="fa-solid fa-book-open" style="margin-right:8px;"></i> View Full
              </button>

              ${admin ? `
                <button class="btn-small btn-edit" type="button" data-action="edit" data-id="${escapeHtml(id)}">
                  <i class="fa-solid fa-pen" style="margin-right:8px;"></i> Edit
                </button>
              ` : ""}
            </div>
          </div>
        `;

        blogGrid.appendChild(card);
      });

      blogGrid.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          const blog = allBlogs.find(x => (x._id || x.id) == id);
          if (!blog) return;

          if (action === "view") openViewModal(blog);
          if (action === "edit") openEditModal(blog);
        });
      });
    }

    async function fetchBlogs() {
      hideAlert(alertEl);
      statusEl.textContent = "Loading blogs...";
      blogGrid.innerHTML = "";

      try {
        const res = await fetch(`${API_BASE}/api/blog`, { method: "GET" });
        let data = {};
        try { data = await res.json(); } catch { }

        if (!res.ok) {
          showAlert(alertEl, "error", data?.message || data?.error || "Failed to load blogs.");
          statusEl.textContent = "Unable to load blogs.";
          return;
        }

        allBlogs = normalizeBlogs(data);
        allBlogs.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        render(allBlogs);

      } catch {
        showAlert(alertEl, "error", "Server not reachable. Make sure backend is running on localhost:5000.");
        statusEl.textContent = "Unable to load blogs.";
      }
    }

    function setCreateLoading(isLoading) {
      const btn = document.getElementById("createBtn");
      btn.disabled = isLoading;
      btn.style.opacity = isLoading ? "0.75" : "1";
      btn.innerHTML = isLoading
        ? `<i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> Creating...`
        : `<i class="fa-solid fa-plus" style="margin-right:8px;"></i> Create Blog`;
    }

    function setEditLoading(isLoading) {
      const btn = document.getElementById("saveEditBtn");
      btn.disabled = isLoading;
      btn.style.opacity = isLoading ? "0.75" : "1";
      btn.innerHTML = isLoading
        ? `<i class="fa-solid fa-spinner fa-spin" style="margin-right:8px;"></i> Saving...`
        : `<i class="fa-solid fa-floppy-disk" style="margin-right:8px;"></i> Save Changes`;
    }

    // ======= View Modal =======
    function openViewModal(blog) {
      const title = blog.title || "Blog";
      const category = blog.category || "General";
      const published = Boolean(blog.published);
      const author = blog.author || "Sara Wellness Team";
      const date = formatDate(blog.createdAt);
      const imgUrl = resolveImageUrl(blog.image);
      const tags = Array.isArray(blog.tags) ? blog.tags : [];

      document.getElementById("viewTitle").textContent = title;
      document.getElementById("viewCategory").textContent = category;
      document.getElementById("viewPublished").textContent = published ? "Published" : "Draft";
      document.getElementById("viewPublished").className = `pill ${published ? "" : "draft"}`;
      document.getElementById("viewInfo").innerHTML =
        `<i class="fa-solid fa-user-pen"></i> <b>${escapeHtml(author)}</b>` +
        (date ? ` &nbsp; | &nbsp; <i class="fa-regular fa-calendar"></i> ${escapeHtml(date)}` : "");

      const wrap = document.getElementById("viewImageWrap");
      wrap.innerHTML = imgUrl
        ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(title)}" onerror="this.parentElement.innerHTML='<i class=\\'fa-solid fa-image\\' style=\\'font-size:34px; color:#2E8B57;\\'></i>'">`
        : `<i class="fa-solid fa-image" style="font-size:34px; color:#2E8B57;"></i>`;

      document.getElementById("viewContent").textContent = blog.content || "";
      document.getElementById("viewTags").innerHTML = tags.length
        ? `<i class="fa-solid fa-tags"></i> ${escapeHtml(tags.join(", "))}`
        : "";

      viewBackdrop.style.display = "block";
      viewBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeView() {
      viewBackdrop.style.display = "none";
      viewBackdrop.setAttribute("aria-hidden", "true");
    }

    closeViewModal.addEventListener("click", closeView);
    viewBackdrop.addEventListener("click", (e) => { if (e.target === viewBackdrop) closeView(); });

    // ======= Edit Modal (Admin) =======
    function openEditModal(blog) {
      if (!isAdmin()) return;

      hideAlert(editAlert);

      const id = blog._id || blog.id;
      document.getElementById("editId").value = id || "";
      document.getElementById("editTitle").value = blog.title || "";
      document.getElementById("editCategory").value = blog.category || "";
      document.getElementById("editContent").value = blog.content || "";
      document.getElementById("editExcerpt").value = blog.excerpt || "";
      document.getElementById("editTags").value = Array.isArray(blog.tags) ? blog.tags.join(", ") : "";
      document.getElementById("editPublished").value = String(Boolean(blog.published));
      document.getElementById("editImageFile").value = "";

      const u = getUser();
      document.getElementById("editAuthor").value = u?.name || "Sara Wellness Team";

      const imgUrl = resolveImageUrl(blog.image);
      document.getElementById("editCurrentImage").innerHTML = imgUrl
        ? `Current: <a href="${escapeHtml(imgUrl)}" target="_blank" rel="noopener">View image</a>`
        : "No image";

      editBackdrop.style.display = "block";
      editBackdrop.setAttribute("aria-hidden", "false");
    }

    function closeEdit() {
      editBackdrop.style.display = "none";
      editBackdrop.setAttribute("aria-hidden", "true");
      hideAlert(editAlert);
    }

    closeEditModal.addEventListener("click", closeEdit);
    editBackdrop.addEventListener("click", (e) => { if (e.target === editBackdrop) closeEdit(); });

    // ======= Create blog (multipart) =======
    if (createForm) {
      createForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideAlert(createAlert);

        const token = getToken();
        if (!token || !isAdmin()) {
          showAlert(createAlert, "error", "Only admins can create blogs. Please login as admin.");
          return;
        }

        const title = document.getElementById("title").value.trim();
        const category = document.getElementById("category").value.trim();
        const content = document.getElementById("content").value.trim();
        const excerptInput = document.getElementById("excerpt").value.trim();
        const tagsInput = document.getElementById("tags").value.trim();
        const published = document.getElementById("published").value === "true";

        if (!title || !category || !content) {
          showAlert(createAlert, "error", "Title, Category and Content are required.");
          return;
        }

        const excerpt = excerptInput || autoExcerpt(content);
        const author = getUser()?.name || "Sara Wellness Team";
        const tags = tagsInput
          ? tagsInput.split(",").map(t => t.trim()).filter(Boolean)
          : autoTags(category, content);

        const imageFile = document.getElementById("imageFile").files?.[0] || null;

        const fd = new FormData();
        fd.append("title", title);
        fd.append("content", content);
        fd.append("excerpt", excerpt);
        fd.append("author", author);
        fd.append("category", category);
        fd.append("published", String(published));
        tags.forEach(t => fd.append("tags[]", t));
        if (imageFile) fd.append("image", imageFile);

        setCreateLoading(true);

        try {
          const res = await fetch(`${API_BASE}/api/blog`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` },
            body: fd
          });

          let data = {};
          try { data = await res.json(); } catch { }

          if (!res.ok) {
            showAlert(createAlert, "error", data?.message || data?.error || "Failed to create blog.");
            setCreateLoading(false);
            return;
          }

          showAlert(createAlert, "success", "Blog created successfully!");
          createForm.reset();

          const authorInput = document.getElementById("author");
          if (authorInput) authorInput.value = author;

          setCreateLoading(false);
          fetchBlogs();
        } catch {
          showAlert(createAlert, "error", "Server not reachable. Make sure backend is running.");
          setCreateLoading(false);
        }
      });
    }

    // ======= Edit blog (multipart PUT) =======
    if (editForm) {
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        hideAlert(editAlert);

        const token = getToken();
        if (!token || !isAdmin()) {
          showAlert(editAlert, "error", "Only admins can edit blogs.");
          return;
        }

        const id = document.getElementById("editId").value;
        const title = document.getElementById("editTitle").value.trim();
        const category = document.getElementById("editCategory").value.trim();
        const content = document.getElementById("editContent").value.trim();
        const excerptInput = document.getElementById("editExcerpt").value.trim();
        const tagsInput = document.getElementById("editTags").value.trim();
        const published = document.getElementById("editPublished").value === "true";

        if (!id) return showAlert(editAlert, "error", "Missing blog id.");
        if (!title || !category || !content) return showAlert(editAlert, "error", "Title, Category and Content are required.");

        const excerpt = excerptInput || autoExcerpt(content);
        const author = getUser()?.name || "Sara Wellness Team";
        const tags = tagsInput
          ? tagsInput.split(",").map(t => t.trim()).filter(Boolean)
          : autoTags(category, content);

        const imageFile = document.getElementById("editImageFile").files?.[0] || null;

        const fd = new FormData();
        fd.append("title", title);
        fd.append("content", content);
        fd.append("excerpt", excerpt);
        fd.append("author", author);
        fd.append("category", category);
        fd.append("published", String(published));
        tags.forEach(t => fd.append("tags[]", t));
        if (imageFile) fd.append("image", imageFile);

        setEditLoading(true);

        try {
          const res = await fetch(`${API_BASE}/api/blog/${encodeURIComponent(id)}`, {
            method: "PUT",
            headers: { "Authorization": `Bearer ${token}` },
            body: fd
          });

          let data = {};
          try { data = await res.json(); } catch { }

          if (!res.ok) {
            showAlert(editAlert, "error", data?.message || data?.error || "Failed to update blog.");
            setEditLoading(false);
            return;
          }

          showAlert(editAlert, "success", "Blog updated successfully!");
          setEditLoading(false);

          await fetchBlogs();
          setTimeout(closeEdit, 700);
        } catch {
          showAlert(editAlert, "error", "Server not reachable. Make sure backend is running.");
          setEditLoading(false);
        }
      });
    }

    // Init
    setAdminVisibility();
    fetchBlogs();
  </script>

  <!-- Header loader (kept) -->
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("header-placeholder").innerHTML = html;

        function getToken() { return localStorage.getItem("token"); }
        function getUser() { try { return JSON.parse(localStorage.getItem("user") || "null"); } catch { return null; } }
        function isAdmin() { const u = getUser(); return (u?.role || "").toLowerCase() === "admin"; }

        const token = getToken();
        const guest1 = document.getElementById("nav-auth-guest");
        const guest2 = document.getElementById("nav-auth-guest-2");
        const userNav = document.getElementById("nav-auth-user");
        const roleLi = document.getElementById("nav-role-link");

        if (token) {
          if (guest1) guest1.style.display = "none";
          if (guest2) guest2.style.display = "none";
          if (userNav) userNav.style.display = "inline-block";

          if (roleLi) {
            roleLi.style.display = "inline-block";
            roleLi.innerHTML = isAdmin()
              ? `<a href="dashboard.html" data-nav="dashboard"><i class="fa-solid fa-gauge" style="margin-right:8px;"></i>Dashboard</a>`
              : `<a href="profile.html" data-nav="profile"><i class="fa-solid fa-user" style="margin-right:8px;"></i>Profile</a>`;
          }
        } else {
          if (guest1) guest1.style.display = "inline-block";
          if (guest2) guest2.style.display = "inline-block";
          if (userNav) userNav.style.display = "none";
          if (roleLi) roleLi.style.display = "none";
        }

        const logoutLink = document.getElementById("logout-link");
        if (logoutLink) {
          logoutLink.addEventListener("click", (e) => {
            e.preventDefault();
            localStorage.removeItem("token");
            localStorage.removeItem("user");
            window.location.href = "login.html";
          });
        }

        const current = (location.pathname.split("/").pop() || "index.html").toLowerCase();
        const map = {
          "index.html": "home",
          "services.html": "services",
          "about.html": "about",
          "testimonials.html": "testimonials",
          "blog.html": "blog",
          "contact.html": "contact",
          "login.html": "login",
          "register.html": "register",
          "profile.html": "profile",
          "dashboard.html": "dashboard"
        };
        const key = map[current];
        if (key) {
          const activeLink = document.querySelector(`.sw-nav a[data-nav="${key}"]`);
          if (activeLink) activeLink.classList.add("active");
        }

        const burger = document.getElementById("sw-burger");
        const nav = document.getElementById("sw-nav");
        if (burger && nav) {
          const closeMenu = () => {
            nav.classList.remove("open");
            burger.classList.remove("is-open");
            burger.setAttribute("aria-expanded", "false");
          };

          burger.addEventListener("click", () => {
            const open = nav.classList.toggle("open");
            burger.classList.toggle("is-open", open);
            burger.setAttribute("aria-expanded", open ? "true" : "false");
          });

          nav.addEventListener("click", (e) => {
            const a = e.target.closest("a");
            if (a && window.innerWidth <= 900) closeMenu();
          });

          window.addEventListener("resize", () => {
            if (window.innerWidth > 900) closeMenu();
          });

          document.addEventListener("click", (e) => {
            if (window.innerWidth > 900) return;
            if (!nav.classList.contains("open")) return;
            const inside = e.target.closest("#sw-nav") || e.target.closest("#sw-burger");
            if (!inside) closeMenu();
          });
        }
      });
  </script>
  <!-- ✅ Single-file reusable chatbot (NO fetch, NO extra files)
     Paste this near the END of <body> in ANY page.
     Requirements: FontAwesome link in <head> (optional, icons will fallback if missing)
-->

<style>
  /* ===== Sara Wellness Reusable Chatbot (Single-file) ===== */
  #sw-chatbot{position:fixed;bottom:30px;right:30px;z-index:9999}
  #sw-chatbot .sw-chatbot-btn{
    width:60px;height:60px;border-radius:50%;
    background:linear-gradient(135deg,#DC143C,#4B0082);
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:1.5rem;cursor:pointer;
    box-shadow:0 5px 15px rgba(0,0,0,.2);
    transition:transform .3s ease;animation:swPulse 2s infinite;
    user-select:none;
  }
  #sw-chatbot .sw-chatbot-btn:hover{transform:scale(1.1)}
  @keyframes swPulse{
    0%{box-shadow:0 0 0 0 rgba(220,20,60,.7)}
    70%{box-shadow:0 0 0 15px rgba(220,20,60,0)}
    100%{box-shadow:0 0 0 0 rgba(220,20,60,0)}
  }

  #sw-chatbot .sw-chatbot-window{
    position:absolute;bottom:70px;right:0;
    width:350px;height:450px;background:#fff;border-radius:15px;
    box-shadow:0 5px 25px rgba(0,0,0,.2);
    display:none;flex-direction:column;overflow:hidden;
    border:2px solid #DC143C;
  }
  #sw-chatbot .sw-chatbot-window.show{display:flex}

  #sw-chatbot .sw-chatbot-header{
    background:linear-gradient(135deg,#DC143C,#4B0082);
    color:#fff;padding:15px;display:flex;align-items:center;justify-content:space-between
  }
  #sw-chatbot .sw-chatbot-header h3{font-size:1rem;margin:0}
  #sw-chatbot .sw-close{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%}
  #sw-chatbot .sw-close:hover{background:rgba(255,255,255,.15)}

  #sw-chatbot .sw-messages{
    flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px
  }
  #sw-chatbot .sw-message{
    max-width:80%;padding:10px 15px;border-radius:20px;line-height:1.4;font-size:.95rem;white-space:pre-wrap
  }
  #sw-chatbot .sw-bot{background:#f1f1f1;align-self:flex-start;border-bottom-left-radius:6px;color:#343a40}
  #sw-chatbot .sw-user{background:#DC143C;color:#fff;align-self:flex-end;border-bottom-right-radius:6px}

  #sw-chatbot .sw-input{
    display:flex;gap:10px;padding:10px;border-top:1px solid #ddd;background:#fff
  }
  #sw-chatbot .sw-input input{
    flex:1;padding:10px;border:1px solid #ddd;border-radius:20px;outline:none
  }
  #sw-chatbot .sw-input button{
    width:40px;height:40px;border:none;border-radius:50%;
    background:#DC143C;color:#fff;cursor:pointer;flex:0 0 auto
  }

  @media (max-width:768px){
    #sw-chatbot{bottom:20px;right:20px}
    #sw-chatbot .sw-chatbot-window{width:300px;height:400px}
  }
</style>

<div id="sw-chatbot" aria-live="polite">
  <div class="sw-chatbot-btn" id="sw-chatbot-btn" aria-label="Open chat" role="button" tabindex="0">
    <i class="fas fa-comment-medical" aria-hidden="true"></i>
  </div>

  <div class="sw-chatbot-window" id="sw-chatbot-window" aria-hidden="true">
    <div class="sw-chatbot-header">
      <h3>Sara Wellness Assistant</h3>
      <span class="sw-close" id="sw-chatbot-close" aria-label="Close chat" role="button" tabindex="0">
        <i class="fas fa-times" aria-hidden="true"></i>
      </span>
    </div>

    <div class="sw-messages" id="sw-chatbot-messages">
      <div class="sw-message sw-bot">
        Hello! I'm Sara, your wellness assistant. You can ask me anything about our services: weight loss, hair loss, skin care, stress management, pain relief, or personal problems.
      </div>
    </div>

    <div class="sw-input">
      <input type="text" id="sw-user-input" placeholder="Type your question here..." autocomplete="off" />
      <button id="sw-send-btn" aria-label="Send message">
        <i class="fas fa-paper-plane" aria-hidden="true"></i>
      </button>
    </div>
  </div>
</div>



<script>
  (function () {
    // Avoid double-init if pasted twice
    if (window.__SW_CHATBOT_INIT__) return;
    window.__SW_CHATBOT_INIT__ = true;

    const btn = document.getElementById("sw-chatbot-btn");
    const win = document.getElementById("sw-chatbot-window");
    const closeBtn = document.getElementById("sw-chatbot-close");
    const input = document.getElementById("sw-user-input");
    const sendBtn = document.getElementById("sw-send-btn");
    const messages = document.getElementById("sw-chatbot-messages");

    function openChat() {
      win.classList.add("show");
      win.setAttribute("aria-hidden", "false");
      setTimeout(() => input && input.focus(), 50);
    }

    function closeChat() {
      win.classList.remove("show");
      win.setAttribute("aria-hidden", "true");
    }

    function addMessage(text, sender) {
      const el = document.createElement("div");
      el.className = "sw-message " + (sender === "user" ? "sw-user" : "sw-bot");
      el.textContent = text;
      messages.appendChild(el);
      messages.scrollTop = messages.scrollHeight;
    }

    function generateResponse(message) {
      const msg = String(message || "").toLowerCase();

      // Weight loss
      if (msg.includes("weight") || msg.includes("diet") || msg.includes("obese") || msg.includes("fat")) {
        return "Our weight loss program includes personalized diet plans, exercise routines, and lifestyle modifications. We focus on sustainable weight loss rather than quick fixes.";
      }

      // Hair loss
      if (msg.includes("hair") || msg.includes("bald") || msg.includes("scalp")) {
        return "We offer comprehensive hair loss treatments including scalp therapies, nutritional guidance, and natural remedies to promote hair growth and reduce hair fall.";
      }

      // Skin care
      if (msg.includes("skin") || msg.includes("acne") || msg.includes("pimple") || msg.includes("glow")) {
        return "Our skin care treatments address concerns like acne, aging, pigmentation, and dryness. We use a combination of advanced treatments and natural approaches.";
      }

      // Stress
      if (msg.includes("stress") || msg.includes("anxiety") || msg.includes("tension") || msg.includes("worry")) {
        return "Our stress management program includes counseling, relaxation techniques, mindfulness practices, and lifestyle adjustments to help you manage stress effectively.";
      }

      // Pain relief (fixed your old typo: imcludes -> includes)
      if (
        msg.includes("pain") ||
        msg.includes("joint") ||
        msg.includes("joints") ||
        msg.includes("sprain") ||
        msg.includes("shoulder") ||
        msg.includes("muscle") ||
        msg.includes("stomach ache")
      ) {
        return "Our pain relief service offers natural and holistic approaches to manage and relieve chronic pain, improving your quality of life through proven techniques.";
      }

      // Personal problems / general issues
      if (msg.includes("personal") || msg.includes("problem") || msg.includes("issue")) {
        return "We provide discreet support for sensitive personal concerns in a safe, confidential environment. For private guidance, please book a consultation via our contact page.";
      }

      // Appointment
      if (msg.includes("appointment") || msg.includes("schedule") || msg.includes("book") || msg.includes("meet")) {
        return "You can book an appointment by calling +977-15225050 or by using our contact page. Our staff will get back to you soon.";
      }

      // Price
      if (msg.includes("price") || msg.includes("cost") || msg.includes("fee") || msg.includes("charge")) {
        return "Pricing depends on the treatment plan. Please contact us for specific packages and consultation details.";
      }

      // Greetings
      if (msg.includes("hello") || msg.includes("hi") || msg.includes("hey") || msg.includes("namaste")) {
        return "Hello! How can I help you with your wellness journey today?";
      }

      if (msg.includes("thank")) {
        return "You're welcome! Is there anything else you'd like to know about our services?";
      }

      return "Thank you for your question. I can share info about our wellness services. For more specific help, please contact us directly.";
    }

    function sendMessage() {
      const text = (input.value || "").trim();
      if (!text) return;

      addMessage(text, "user");
      input.value = "";

      setTimeout(() => addMessage(generateResponse(text), "bot"), 600);
    }

    // Click handlers
    btn.addEventListener("click", openChat);
    closeBtn.addEventListener("click", closeChat);
    sendBtn.addEventListener("click", sendMessage);

    // Enter to send
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendMessage();
      if (e.key === "Escape") closeChat();
    });

    // Allow keyboard access on open/close icons
    btn.addEventListener("keydown", (e) => { if (e.key === "Enter") openChat(); });
    closeBtn.addEventListener("keydown", (e) => { if (e.key === "Enter") closeChat(); });

    // Optional: ESC anywhere closes if open
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && win.classList.contains("show")) closeChat();
    });
  })();
</script>


</body>

</html>